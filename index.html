<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tab Organizer Ultra - Full Features & Cloud</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: radial-gradient(circle at top left, #1e293b, #0f172a);
        min-height: 100vh;
        color: #cbd5e1;
    }
    .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .glass-sidebar {
        background: rgba(30, 41, 59, 0.85);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glass-card {
        background: rgba(255, 255, 255, 0.03);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
    }
    .glass-card:hover {
        transform: translateY(-4px) scale(1.01);
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 20px -10px rgba(0,0,0,0.5);
    }
    @keyframes modalIn {
        from { opacity: 0; transform: scale(0.9) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal-content { animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

    .smart-highlight {
        background: rgba(59, 130, 246, 0.12) !important;
        border-color: rgba(59, 130, 246, 0.5) !important;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
    }
    .modal-active { display: flex !important; }

    .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(14px); }

    .loading-pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

    /* Library sidebar styles */
    .library-item {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .library-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }
    .library-item.active {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.5);
    }

    /* Video Focus Mode */
    .focus-modal {
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(20px);
    }

    /* Checkbox styles for status - 4 states */
    .status-checkbox {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        flex-shrink: 0;
    }
    .status-checkbox:checked {
        background: #22c55e;
        border-color: #22c55e;
    }
    .status-checkbox:checked::after {
        content: '‚úì';
        position: absolute;
        color: white;
        font-size: 10px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .status-checkbox.watching:checked { background: #fbbf24; border-color: #fbbf24; }
    .status-checkbox.watched:checked { background: #3b82f6; border-color: #3b82f6; }
    .status-checkbox.understood:checked { background: #22c55e; border-color: #22c55e; }
    .status-checkbox.applied:checked { background: #f59e0b; border-color: #f59e0b; }

    /* Status badges */
    .status-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 9999px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .badge-watching { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
    .badge-watched { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    .badge-understood { background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
    .badge-applied { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }

    /* Save indicator */
    @keyframes saveFlash {
        0% { opacity: 0; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(0.8); }
    }
    .save-indicator {
        animation: saveFlash 1.5s ease-out;
    }

    /* Quick note input */
    .quick-note-input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.2s;
    }
    .quick-note-input:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(59, 130, 246, 0.5);
        outline: none;
    }

    /* Next video thumbnails */
    .next-video-item {
        transition: all 0.2s;
        cursor: pointer;
    }
    .next-video-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    .next-video-item.current {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.5);
    }

    /* Focus mode scrollbar */
    .focus-sidebar::-webkit-scrollbar { width: 4px; }
    .focus-sidebar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
</style>
</head>
<body class="p-4 md:p-6">
<div class="max-w-7xl mx-auto">
<header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
    <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight flex items-center gap-3">
            <span class="bg-blue-600/20 p-2 rounded-xl border border-blue-500/20">üìë</span> Tab Organizer
        </h1>
        <p class="text-slate-500 text-sm mt-1">Tu centro de mando digital con IA de metadatos.</p>
    </div>
    <div class="flex flex-wrap gap-2 md:gap-3 text-white items-center justify-center md:justify-end">
        <span id="cloud-status" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest order-first w-full md:w-auto text-center md:text-left md:mr-2">Iniciando...</span>
        <div id="user-info" class="flex items-center gap-2">
            <span id="user-email" class="text-xs text-slate-400 hidden max-w-[120px] md:max-w-[180px] truncate"></span>
        </div>
        <button onclick="save()" title="Forzar Sincronizaci√≥n" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">‚òÅÔ∏è</button>
        <button onclick="openExportModal()" title="Exportar datos" class="px-3 md:px-4 py-2 rounded-lg border border-slate-700 hover:bg-slate-800 transition text-sm font-medium">üì§ Export</button>
        <button onclick="openImportModal()" title="Importar datos" class="px-3 md:px-4 py-2 rounded-lg border border-slate-700 hover:bg-slate-800 transition text-sm font-medium">üì• Import</button>
        <button id="manageBtn" onclick="toggleManageCategories()" class="px-3 md:px-4 py-2 rounded-lg border border-slate-700 hover:bg-slate-800 transition text-sm font-medium">Gestionar</button>
        <button onclick="openCategoryModal()" class="px-3 md:px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white shadow-lg transition text-sm font-medium">+ Categor√≠a</button>
        <button id="auth-btn" onclick="handleAuth()" class="px-3 md:px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg transition text-sm font-medium">Login</button>
    </div>
</header>

<!-- Mobile Library Selector -->
<div id="mobile-library-selector" class="md:hidden mb-4">
    <select id="mobile-library-dropdown" onchange="selectLibrary(this.value)" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition">
    </select>
</div>

<!-- Main Layout with Sidebar -->
<div class="flex gap-6">
    <!-- Library Sidebar (Desktop) -->
    <aside id="library-sidebar" class="hidden md:block w-[180px] flex-shrink-0">
        <div class="glass-sidebar rounded-2xl p-4 sticky top-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Librer√≠as</h3>
                <button onclick="openLibraryModal()" class="text-blue-400 hover:text-blue-300 transition text-lg" title="Nueva Librer√≠a">+</button>
            </div>
            <div id="library-list" class="space-y-1">
                <!-- Libraries rendered here -->
            </div>
            <div class="mt-4 pt-4 border-t border-white/5">
                <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer hover:text-slate-400 transition">
                    <input type="checkbox" id="search-all-libraries" class="accent-blue-500" onchange="render()">
                    <span>Buscar en todas</span>
                </label>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-0">
        <div id="sections-container" class="space-y-6"></div>
    </main>
</div>

<!-- Pantalla de bienvenida para usuarios no logueados -->
<div id="welcome-screen" class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-md z-40 items-center justify-center p-4 overflow-y-auto">
    <div class="glass modal-content p-8 md:p-12 rounded-3xl max-w-lg text-center shadow-2xl my-8">
        <div class="text-6xl mb-6">üìë</div>
        <h2 class="text-3xl font-bold text-white mb-4">Tab Organizer</h2>
        <p class="text-slate-400 mb-8">Organiza todos tus links en un solo lugar.</p>

        <!-- Google OAuth -->
        <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-3 px-6 py-4 rounded-xl bg-white hover:bg-gray-100 text-slate-800 font-bold shadow-lg transition text-lg">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Continuar con Google
        </button>

        <!-- Separador -->
        <div class="flex items-center gap-4 my-6">
            <div class="flex-1 h-px bg-slate-700"></div>
            <span class="text-slate-500 text-sm">o</span>
            <div class="flex-1 h-px bg-slate-700"></div>
        </div>

        <!-- Email/Password Form -->
        <div class="space-y-3">
            <input id="auth-email" type="email" placeholder="Email" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition" />
            <input id="auth-password" type="password" placeholder="Contrase√±a" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition" />
            <p id="auth-error" class="text-red-400 text-xs hidden"></p>
            <div class="flex gap-3">
                <button onclick="signUpWithEmail()" class="flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg transition">
                    Crear cuenta
                </button>
                <button onclick="signInWithEmail()" class="flex-1 px-4 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg transition">
                    Iniciar sesi√≥n
                </button>
            </div>
        </div>

        <!-- Separador -->
        <div class="flex items-center gap-4 my-6">
            <div class="flex-1 h-px bg-slate-700"></div>
            <span class="text-slate-500 text-sm">o</span>
            <div class="flex-1 h-px bg-slate-700"></div>
        </div>

        <!-- Guest Mode -->
        <button onclick="enterGuestMode()" class="w-full flex flex-col items-center justify-center gap-1 px-6 py-4 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-bold shadow-lg transition">
            <span class="text-lg">üë§ Probar como invitado</span>
            <span class="text-[10px] text-slate-500 font-normal">(Sin sincronizaci√≥n en nube)</span>
        </button>

        <p class="text-slate-600 text-xs mt-6">Con Google o Email tus datos se sincronizan en la nube</p>
    </div>
</div>
</div>

<!-- Link Modal -->
<div id="link-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-md shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 id="link-modal-title" class="text-xl font-bold text-white">Nuevo Link</h3>
            <span id="auto-status" class="text-[10px] text-blue-400 font-bold uppercase"></span>
        </div>
        <div class="space-y-4">
            <input id="link-url" oninput="fetchMetadata(this.value)" placeholder="https://..." class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition" />

            <div class="flex gap-3 items-center bg-slate-900/50 p-2 rounded-xl border border-slate-800">
                <img id="link-icon-preview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="w-10 h-10 rounded-lg bg-slate-700 object-contain">
                <input id="link-title" placeholder="T√≠tulo (Autom√°tico)" class="flex-1 bg-transparent text-white outline-none font-medium text-sm" />
            </div>

            <textarea id="link-desc" placeholder="Descripci√≥n (Autom√°tica)" rows="3" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition text-sm"></textarea>

            <div class="flex gap-3 pt-2">
                <button class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white hover:bg-blue-500 transition" onclick="saveLink()">Guardar Link</button>
                <button class="px-6 py-3 rounded-xl bg-slate-800 font-bold hover:bg-slate-700 transition" onclick="closeLinkModal()">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div id="category-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-md shadow-2xl">
        <h3 id="category-modal-title" class="text-xl font-bold text-white mb-6">Ajustes de Categor√≠a</h3>
        <div class="space-y-4 mb-6">
            <input id="cat-name" placeholder="Nombre" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500" />
            <input id="cat-progress" placeholder="Estado (Video 5...)" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-blue-400 text-sm outline-none" />
            <textarea id="cat-desc" placeholder="Descripci√≥n General" rows="2" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-slate-300 text-sm outline-none"></textarea>
        </div>
        <div class="flex flex-wrap gap-2 mb-6" id="icon-grid"></div>
        <div class="flex flex-wrap gap-2 mb-8" id="color-grid"></div>
        <div class="flex gap-3">
            <button class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white" onclick="saveCategory()">Guardar</button>
            <button class="px-6 py-3 rounded-xl bg-slate-800 font-bold" onclick="closeCategoryModal()">Cancelar</button>
        </div>
    </div>
</div>

<!-- Library Modal -->
<div id="library-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-md shadow-2xl">
        <h3 id="library-modal-title" class="text-xl font-bold text-white mb-6">Nueva Librer√≠a</h3>
        <div class="space-y-4 mb-6">
            <input id="lib-name" placeholder="Nombre de la librer√≠a" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500" />
        </div>
        <p class="text-xs text-slate-500 mb-3">Selecciona un icono:</p>
        <div class="flex flex-wrap gap-2 mb-6" id="lib-icon-grid"></div>
        <div class="flex gap-3">
            <button class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white" onclick="saveLibrary()">Guardar</button>
            <button class="px-6 py-3 rounded-xl bg-slate-800 font-bold" onclick="closeLibraryModal()">Cancelar</button>
        </div>
    </div>
</div>

<!-- Video Focus Mode Modal - REDESIGNED -->
<div id="video-focus-modal" class="hidden fixed inset-0 focus-modal z-50 overflow-y-auto">
    <div class="min-h-full w-full max-w-7xl mx-auto flex flex-col p-4 md:p-6">
        <!-- Close button -->
        <button onclick="closeVideoFocusModal()" class="fixed top-4 left-4 md:top-6 md:left-6 z-20 p-2 rounded-lg bg-white/10 hover:bg-white/20 transition text-white text-xl" title="Cerrar (ESC)">‚úï</button>

        <!-- Main Content Area -->
        <div class="flex flex-col md:flex-row gap-4 md:gap-6 flex-1 mt-12 md:mt-8">
            <!-- Left Column: Title + Video + Notes -->
            <div class="flex-1 flex flex-col min-w-0">
                <!-- Video Title (above video) -->
                <h2 id="video-focus-title" class="text-xl md:text-2xl font-bold text-white mb-4 line-clamp-2">Video Title</h2>

                <!-- Video Player -->
                <div id="video-focus-player" class="w-full aspect-video bg-black rounded-2xl overflow-hidden border border-white/10 shadow-2xl">
                    <!-- Video iframe/player inserted here -->
                </div>

                <!-- Notes Section (below video) -->
                <div class="mt-4 space-y-2">
                    <div class="flex items-center justify-between">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Notas completas</p>
                        <span id="focus-save-status" class="text-[10px] text-slate-500"></span>
                    </div>
                    <textarea id="focus-full-note" placeholder="Tus notas completas sobre este video (m√°x 500 caracteres)..." maxlength="500" rows="4" class="w-full quick-note-input p-4 rounded-xl text-white text-sm resize-none" oninput="debounceSaveFullNote()"></textarea>
                    <p class="text-[10px] text-slate-600 text-right"><span id="full-note-char-count">0</span>/500</p>
                </div>
            </div>

            <!-- Right Sidebar Panel -->
            <div class="md:w-[280px] flex-shrink-0 glass rounded-2xl p-5 overflow-y-auto focus-sidebar max-h-[50vh] md:max-h-[calc(100vh-120px)]">
                <!-- Library & Category Info -->
                <div class="mb-5 pb-4 border-b border-white/10">
                    <div class="flex items-center gap-2 text-sm">
                        <span id="focus-lib-icon" class="text-lg">üìö</span>
                        <span id="focus-lib-name" class="text-slate-300 font-medium truncate">Library</span>
                    </div>
                    <p id="focus-cat-name" class="text-xs text-slate-500 mt-1 truncate">Category</p>
                </div>

                <!-- Status Checkboxes (4 states) -->
                <div class="mb-5 pb-4 border-b border-white/10">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Estado</p>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-white/5 transition">
                            <input type="checkbox" id="focus-watching" class="status-checkbox watching" onchange="updateFocusStatus()">
                            <span class="text-yellow-400">üü°</span>
                            <span class="text-white text-sm group-hover:text-yellow-400 transition">Viendo</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-white/5 transition">
                            <input type="checkbox" id="focus-watched" class="status-checkbox watched" onchange="updateFocusStatus()">
                            <span class="text-blue-400">üîµ</span>
                            <span class="text-white text-sm group-hover:text-blue-400 transition">Visto</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-white/5 transition">
                            <input type="checkbox" id="focus-understood" class="status-checkbox understood" onchange="updateFocusStatus()">
                            <span class="text-emerald-400">üü¢</span>
                            <span class="text-white text-sm group-hover:text-emerald-400 transition">Entendido</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group p-2 rounded-lg hover:bg-white/5 transition">
                            <input type="checkbox" id="focus-applied" class="status-checkbox applied" onchange="updateFocusStatus()">
                            <span class="text-amber-400">‚≠ê</span>
                            <span class="text-white text-sm group-hover:text-amber-400 transition">Aplicado</span>
                        </label>
                    </div>
                </div>

                <!-- Next Videos -->
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Siguiente</p>
                    <div id="focus-next-videos" class="space-y-2">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Link to open externally -->
                <div class="mt-5 pt-4 border-t border-white/10">
                    <a id="focus-link-url" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs truncate block">Abrir en nueva pesta√±a ‚Üí</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Export -->
<div id="export-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-white mb-2">üì§ Exportar Datos</h3>
        <p class="text-slate-500 text-sm mb-6">Selecciona las librer√≠as/categor√≠as que deseas exportar</p>

        <div id="export-categories-list" class="space-y-2 mb-6 max-h-[300px] overflow-y-auto">
            <!-- Se llena din√°micamente -->
        </div>

        <div class="flex gap-3 mb-4">
            <button onclick="selectAllExport(true)" class="flex-1 px-3 py-2 rounded-xl text-xs font-bold text-blue-400 bg-blue-400/10 hover:bg-blue-400/20 transition">Seleccionar Todo</button>
            <button onclick="selectAllExport(false)" class="flex-1 px-3 py-2 rounded-xl text-xs font-bold text-slate-400 bg-slate-700/50 hover:bg-slate-700 transition">Deseleccionar</button>
        </div>

        <div class="flex gap-3">
            <button onclick="executeExport()" class="flex-1 bg-emerald-600 py-3 rounded-xl font-bold text-white hover:bg-emerald-500 transition">Exportar Seleccionadas</button>
            <button onclick="closeExportModal()" class="px-6 py-3 rounded-xl bg-slate-800 font-bold hover:bg-slate-700 transition">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal Import (File Picker) -->
<div id="import-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-md shadow-2xl">
        <h3 class="text-xl font-bold text-white mb-2">üì• Importar Datos</h3>
        <p class="text-slate-500 text-sm mb-6">Selecciona un archivo .json exportado previamente</p>

        <label class="block w-full p-8 border-2 border-dashed border-slate-600 rounded-2xl text-center cursor-pointer hover:border-blue-500 hover:bg-blue-500/5 transition mb-6">
            <input type="file" id="import-file-input" accept=".json" class="hidden" onchange="handleImportFile(this.files[0])" />
            <div class="text-4xl mb-2">üìÅ</div>
            <p class="text-slate-400 font-medium">Click para seleccionar archivo</p>
            <p class="text-slate-600 text-xs mt-1">Solo archivos .json</p>
        </label>

        <p id="import-error" class="text-red-400 text-sm mb-4 hidden"></p>

        <button onclick="closeImportModal()" class="w-full px-6 py-3 rounded-xl bg-slate-800 font-bold hover:bg-slate-700 transition">Cancelar</button>
    </div>
</div>

<!-- Modal Import Preview -->
<div id="import-preview-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold text-white mb-2">üìã Preview de Importaci√≥n</h3>
        <p class="text-slate-500 text-sm mb-6">Revisa los datos antes de importar</p>

        <!-- Resumen -->
        <div id="import-summary" class="bg-slate-800/50 rounded-xl p-4 mb-6 text-sm">
            <!-- Se llena din√°micamente -->
        </div>

        <!-- Categor√≠as nuevas -->
        <div id="import-new-section" class="mb-6 hidden">
            <h4 class="text-sm font-bold text-emerald-400 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 bg-emerald-400 rounded-full"></span> Categor√≠as Nuevas
            </h4>
            <div id="import-new-list" class="space-y-2">
                <!-- Se llena din√°micamente -->
            </div>
        </div>

        <!-- Conflictos -->
        <div id="import-conflicts-section" class="mb-6 hidden">
            <h4 class="text-sm font-bold text-amber-400 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 bg-amber-400 rounded-full"></span> Conflictos (ya existen)
            </h4>
            <div id="import-conflicts-list" class="space-y-3">
                <!-- Se llena din√°micamente -->
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="executeImport()" class="flex-1 bg-emerald-600 py-3 rounded-xl font-bold text-white hover:bg-emerald-500 transition">Confirmar Import</button>
            <button onclick="closeImportPreviewModal()" class="px-6 py-3 rounded-xl bg-slate-800 font-bold hover:bg-slate-700 transition">Cancelar</button>
        </div>
    </div>
</div>

<!-- Notificaci√≥n Toast -->
<div id="toast-notification" class="fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-4 rounded-2xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
    <span id="toast-icon">‚úÖ</span>
    <span id="toast-message">Operaci√≥n exitosa</span>
</div>

<script>
// ================= CONFIG =================
const SUPABASE_URL = 'https://rdipxnnqljdgcfmdemzi.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkaXB4bm5xbGpkZ2NmbWRlbXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMzIyMzQsImV4cCI6MjA4MzkwODIzNH0.TSJFCV2DTzZchL_cLKPsMSB40bjbNuMW0ysVwf-Z7YA';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// NEW DATA STRUCTURE
let DATA = {
    libraries: {},
    currentLibrary: null
};

let openSections = new Set();
let activeCategory = null, activeIndex = null, focusCategory = null, manageCategories = false, editingCategoryKey = null;
let editingLinkIndex = null;
let editingLibraryKey = null;
let currentUser = null;
let isGuest = false;

// Video focus mode state
let focusLibrary = null;
let focusCategory2 = null;
let focusLinkIndex = null;
let noteDebounceTimer = null;
let fullNoteDebounceTimer = null;

const ICONS = ['üìÅ','üìö','üé¨','üß†','‚≠ê','üéØ','üõ†Ô∏è','üßæ','üí°','üìå','üóÇÔ∏è','üß©','üß™','üîñ'];
const LIB_ICONS = ['üìÅ','üìö','üíº','üè†','üéÆ','üéµ','üìñ','üíª','üé®','üì∑','‚úàÔ∏è','üç≥','üí™','üéì','üí∞','‚ù§Ô∏è'];
const COLORS = ['#4a9eff','#a78bfa','#fbbf24','#4ade80','#ef4444','#22d3ee','#f472b6'];

// ================= MIGRATION =================
function migrateOldData(oldData) {
    // Check if already in new format
    if (oldData.libraries) {
        // Migrate existing data to include new status fields
        Object.keys(oldData.libraries).forEach(libKey => {
            const lib = oldData.libraries[libKey];
            Object.keys(lib.categories || {}).forEach(catKey => {
                const cat = lib.categories[catKey];
                (cat.links || []).forEach(link => {
                    // Ensure status has all 4 fields
                    if (!link.status) {
                        link.status = { watching: false, watched: false, understood: false, applied: false };
                    } else {
                        // Add missing fields
                        if (link.status.watching === undefined) link.status.watching = false;
                        if (link.status.understood === undefined) link.status.understood = false;
                        // Keep existing watched/applied values
                    }
                    // Ensure fullNote exists
                    if (link.fullNote === undefined) link.fullNote = '';
                    // Ensure quickNote exists
                    if (link.quickNote === undefined) link.quickNote = '';
                });
            });
        });
        return oldData;
    }

    // Old format: { "categoryKey": { name, icon, color, links, ... } }
    // New format: { libraries: { "libKey": { name, icon, categories: { ... } } }, currentLibrary: "libKey" }

    const defaultLibKey = 'lib_general_' + Date.now();
    const newData = {
        libraries: {
            [defaultLibKey]: {
                name: 'General',
                icon: 'üìÅ',
                categories: {}
            }
        },
        currentLibrary: defaultLibKey
    };

    // Migrate all categories to the "General" library
    Object.keys(oldData).forEach(catKey => {
        const cat = oldData[catKey];
        if (cat && typeof cat === 'object' && cat.name) {
            // Migrate links to new format with 4 status fields
            const migratedLinks = (cat.links || []).map(link => ({
                url: link.url,
                title: link.title,
                description: link.description || '',
                icon: link.icon,
                status: {
                    watching: false,
                    watched: link.isWatching || link.status?.watched || false,
                    understood: false,
                    applied: link.status?.applied || false
                },
                quickNote: link.quickNote || '',
                fullNote: ''
            }));

            newData.libraries[defaultLibKey].categories[catKey] = {
                name: cat.name,
                icon: cat.icon || 'üìÅ',
                color: cat.color || '#4a9eff',
                progress: cat.progress || '',
                description: cat.description || '',
                task: cat.task || '',
                links: migratedLinks
            };
        }
    });

    return newData;
}

function ensureDataStructure() {
    if (!DATA.libraries) {
        DATA = { libraries: {}, currentLibrary: null };
    }

    // Ensure at least one library exists
    const libKeys = Object.keys(DATA.libraries);
    if (libKeys.length === 0) {
        const defaultKey = 'lib_default_' + Date.now();
        DATA.libraries[defaultKey] = {
            name: 'General',
            icon: 'üìÅ',
            categories: {}
        };
        DATA.currentLibrary = defaultKey;
    } else if (!DATA.currentLibrary || !DATA.libraries[DATA.currentLibrary]) {
        DATA.currentLibrary = libKeys[0];
    }
}

// ================= AUTENTICACI√ìN =================
async function initAuth() {
    _supabase.auth.onAuthStateChange((event, session) => {
        if (session?.user) {
            currentUser = session.user;
            updateAuthUI(true);
            load();
        } else {
            currentUser = null;
            updateAuthUI(false);
        }
    });

    const { data: { session } } = await _supabase.auth.getSession();
    if (session?.user) {
        currentUser = session.user;
        updateAuthUI(true);
        load();
    } else {
        updateAuthUI(false);
        loadFromLocalStorage();
    }
}

function loadFromLocalStorage() {
    const s = localStorage.getItem('tabOrganizer');
    if (s) {
        try {
            const parsed = JSON.parse(s);
            DATA = migrateOldData(parsed);
            ensureDataStructure();

            // Show migration notification if data was migrated
            if (!parsed.libraries && Object.keys(parsed).length > 0) {
                setTimeout(() => showToast('Categor√≠as migradas a librer√≠a "General"'), 500);
            }

            render();
        } catch(e) {
            console.error('Error loading local data:', e);
        }
    }
}

function updateAuthUI(isLoggedIn) {
    const authBtn = document.getElementById('auth-btn');
    const userEmail = document.getElementById('user-email');
    const welcomeScreen = document.getElementById('welcome-screen');

    if (isLoggedIn && (currentUser || isGuest)) {
        authBtn.textContent = 'Logout';
        authBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
        authBtn.classList.add('bg-red-600', 'hover:bg-red-500');

        if (isGuest) {
            userEmail.textContent = 'üë§ Invitado';
        } else {
            userEmail.textContent = currentUser.email;
        }
        userEmail.classList.remove('hidden');
        welcomeScreen.classList.remove('modal-active');
        welcomeScreen.classList.add('hidden');
    } else {
        authBtn.textContent = 'Login';
        authBtn.classList.remove('bg-red-600', 'hover:bg-red-500');
        authBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
        userEmail.classList.add('hidden');
        welcomeScreen.classList.add('modal-active');
        welcomeScreen.classList.remove('hidden');
    }
}

async function loginWithGoogle() {
    const { error } = await _supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
            redirectTo: window.location.origin + window.location.pathname
        }
    });
    if (error) {
        console.error('Error de login:', error);
        alert('Error al iniciar sesi√≥n: ' + error.message);
    }
}

function showAuthError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000);
}

async function signUpWithEmail() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;

    if (!email || !password) {
        showAuthError('Por favor ingresa email y contrase√±a');
        return;
    }
    if (password.length < 6) {
        showAuthError('La contrase√±a debe tener al menos 6 caracteres');
        return;
    }

    const { data, error } = await _supabase.auth.signUp({ email, password });

    if (error) {
        console.error('Error signUp:', error);
        showAuthError(error.message);
    } else if (data.user && !data.session) {
        showAuthError('Revisa tu email para confirmar tu cuenta');
    }
}

async function signInWithEmail() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;

    if (!email || !password) {
        showAuthError('Por favor ingresa email y contrase√±a');
        return;
    }

    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

    if (error) {
        console.error('Error signIn:', error);
        showAuthError(error.message);
    }
}

function enterGuestMode() {
    isGuest = true;
    currentUser = null;
    updateAuthUI(true);
    loadFromLocalStorage();
    document.getElementById('cloud-status').innerText = "üë§ Modo Invitado";
    document.getElementById('cloud-status').style.color = "#fbbf24";
}

async function logout() {
    if (!isGuest) {
        const { error } = await _supabase.auth.signOut();
        if (error) console.error('Error de logout:', error);
    }
    isGuest = false;
    currentUser = null;
    DATA = { libraries: {}, currentLibrary: null };
    render();
    updateAuthUI(false);
}

async function handleAuth() {
    if (currentUser || isGuest) {
        logout();
    } else {
        document.getElementById('welcome-screen').classList.add('modal-active');
        document.getElementById('welcome-screen').classList.remove('hidden');
    }
}

// ================= AUTO-METADATA =================
let fetchTimeout;
async function fetchMetadata(url) {
    if (!url.startsWith('http')) return;

    clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(async () => {
        const status = document.getElementById('auto-status');
        status.innerText = "‚è≥ Extrayendo info...";
        status.classList.add('loading-pulse');

        try {
            const response = await fetch(`https://api.microlink.io?url=${encodeURIComponent(url)}`);
            const { data } = await response.json();

            if (data) {
                document.getElementById('link-title').value = data.title || "";
                document.getElementById('link-desc').value = data.description || "";
                const iconUrl = data.logo?.url || data.image?.url || `https://www.google.com/s2/favicons?sz=128&domain=${new URL(url).hostname}`;
                document.getElementById('link-icon-preview').src = iconUrl;
                status.innerText = "‚ú® Auto-completado";
            }
        } catch (e) {
            status.innerText = "‚ö†Ô∏è Error al cargar info";
        } finally {
            status.classList.remove('loading-pulse');
        }
    }, 800);
}

// ================= PERSISTENCIA =================
async function save(){
    ensureDataStructure();
    localStorage.setItem('tabOrganizer', JSON.stringify(DATA));

    const status = document.getElementById('cloud-status');

    if (isGuest) {
        status.innerText = "üë§ Modo Invitado";
        status.style.color = "#fbbf24";
        return;
    }

    if (!currentUser) {
        status.innerText = "üíæ Local";
        status.style.color = "#fbbf24";
        return;
    }

    status.innerText = "‚òÅÔ∏è Guardando...";
    status.style.color = "#60a5fa";

    try {
        const { data: existing, error: selectError } = await _supabase
            .from('tab_organizer')
            .select('id')
            .eq('user_id', currentUser.id)
            .limit(1)
            .maybeSingle();

        if (selectError) {
            console.error('Error checking existing data:', selectError);
            status.innerText = "‚ùå Error Nube";
            status.style.color = "#ef4444";
            return;
        }

        let saveError;

        if (existing) {
            const { error } = await _supabase
                .from('tab_organizer')
                .update({
                    url: 'backup',
                    title: 'FullData',
                    category: JSON.stringify(DATA),
                    updated_at: new Date().toISOString()
                })
                .eq('id', existing.id);
            saveError = error;
        } else {
            const { error } = await _supabase
                .from('tab_organizer')
                .insert({
                    user_id: currentUser.id,
                    url: 'backup',
                    title: 'FullData',
                    category: JSON.stringify(DATA)
                });
            saveError = error;
        }

        status.innerText = saveError ? "‚ùå Error Nube" : "‚úÖ Sincronizado";
        status.style.color = saveError ? "#ef4444" : "#4ade80";
        if (saveError) console.error('Error saving:', saveError);
    } catch (e) {
        console.error('Save exception:', e);
        status.innerText = "‚ùå Error Nube";
        status.style.color = "#ef4444";
    }
}

async function load(){
    loadFromLocalStorage();

    if (isGuest) {
        document.getElementById('cloud-status').innerText = "üë§ Modo Invitado";
        document.getElementById('cloud-status').style.color = "#fbbf24";
        return;
    }

    if (!currentUser) {
        document.getElementById('cloud-status').innerText = "üíæ Modo Local";
        return;
    }

    const { data, error } = await _supabase
        .from('tab_organizer')
        .select('category')
        .eq('user_id', currentUser.id)
        .order('updated_at', { ascending: false })
        .limit(1)
        .maybeSingle();

    if (data?.category) {
        const parsed = JSON.parse(data.category);
        DATA = migrateOldData(parsed);
        ensureDataStructure();
        localStorage.setItem('tabOrganizer', JSON.stringify(DATA));
        render();
        document.getElementById('cloud-status').innerText = "‚úÖ Datos Nube";
    } else if (!error) {
        document.getElementById('cloud-status').innerText = "üÜï Usuario Nuevo";
    }
}

// ================= LIBRARY FUNCTIONS =================
function selectLibrary(libKey) {
    if (DATA.libraries[libKey]) {
        DATA.currentLibrary = libKey;
        focusCategory = null;
        save();
        render();
    }
}

function getCurrentLibrary() {
    ensureDataStructure();
    return DATA.libraries[DATA.currentLibrary];
}

function openLibraryModal(key = null) {
    editingLibraryKey = key;
    document.getElementById('library-modal-title').textContent = key ? 'Editar Librer√≠a' : 'Nueva Librer√≠a';
    document.getElementById('lib-name').value = key ? DATA.libraries[key].name : '';

    const selIcon = key ? DATA.libraries[key].icon : 'üìÅ';
    renderLibIconPicker(selIcon);

    document.getElementById('library-modal').classList.add('modal-active');
}

function closeLibraryModal() {
    document.getElementById('library-modal').classList.remove('modal-active');
    editingLibraryKey = null;
}

function renderLibIconPicker(selected) {
    const grid = document.getElementById('lib-icon-grid');
    grid.innerHTML = '';
    LIB_ICONS.forEach(icon => {
        const d = document.createElement('div');
        d.className = `cursor-pointer p-2 rounded-xl text-xl bg-white/5 hover:bg-white/10 transition ${icon === selected ? 'ring-2 ring-blue-500' : ''}`;
        d.textContent = icon;
        d.onclick = () => renderLibIconPicker(icon);
        if (icon === selected) d.id = 'selected-lib-icon';
        grid.appendChild(d);
    });
}

function saveLibrary() {
    const name = document.getElementById('lib-name').value.trim();
    if (!name) return;

    const icon = document.getElementById('selected-lib-icon')?.textContent || 'üìÅ';

    if (editingLibraryKey) {
        DATA.libraries[editingLibraryKey].name = name;
        DATA.libraries[editingLibraryKey].icon = icon;
    } else {
        const newKey = 'lib_' + Date.now();
        DATA.libraries[newKey] = {
            name,
            icon,
            categories: {}
        };
        DATA.currentLibrary = newKey;
    }

    save();
    closeLibraryModal();
    render();
}

function deleteLibrary(libKey) {
    const libKeys = Object.keys(DATA.libraries);
    if (libKeys.length <= 1) {
        showToast('No puedes eliminar la √∫nica librer√≠a', true);
        return;
    }

    const lib = DATA.libraries[libKey];
    const catCount = Object.keys(lib.categories || {}).length;

    if (!confirm(`¬øEliminar librer√≠a "${lib.name}"${catCount > 0 ? ` con ${catCount} categor√≠a(s)` : ''}?`)) return;

    delete DATA.libraries[libKey];

    if (DATA.currentLibrary === libKey) {
        DATA.currentLibrary = Object.keys(DATA.libraries)[0];
    }

    save();
    render();
}

// ================= STATUS BADGE HELPER =================
function getStatusBadge(status) {
    if (!status) return '';

    // Priority order: Applied > Understood > Watched > Watching
    if (status.applied) {
        return '<span class="status-badge badge-applied">‚≠ê Aplicado</span>';
    }
    if (status.understood) {
        return '<span class="status-badge badge-understood">üü¢ Entendido</span>';
    }
    if (status.watched) {
        return '<span class="status-badge badge-watched">üîµ Visto</span>';
    }
    if (status.watching) {
        return '<span class="status-badge badge-watching">üü° Viendo</span>';
    }
    return '';
}

// ================= UI RENDER =================
function render() {
    ensureDataStructure();
    renderLibrarySidebar();
    renderMobileLibraryDropdown();
    renderCategories();
    document.getElementById('manageBtn').innerText = manageCategories ? 'Hecho' : 'Gestionar';
}

function renderLibrarySidebar() {
    const list = document.getElementById('library-list');
    list.innerHTML = '';

    Object.keys(DATA.libraries).forEach(libKey => {
        const lib = DATA.libraries[libKey];
        const isActive = libKey === DATA.currentLibrary;
        const catCount = Object.keys(lib.categories || {}).length;

        const div = document.createElement('div');
        div.className = `library-item p-3 rounded-xl border border-transparent ${isActive ? 'active' : ''}`;
        div.innerHTML = `
            <div class="flex items-center gap-2" onclick="selectLibrary('${libKey}')">
                <span class="text-lg">${lib.icon}</span>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">${lib.name}</p>
                    <p class="text-[10px] text-slate-500">${catCount} cat.</p>
                </div>
            </div>
            ${manageCategories ? `
                <div class="flex gap-1 mt-2 pt-2 border-t border-white/5">
                    <button onclick="event.stopPropagation(); openLibraryModal('${libKey}')" class="flex-1 text-[10px] px-2 py-1 rounded bg-white/10 hover:bg-white/20 transition">Edit</button>
                    <button onclick="event.stopPropagation(); deleteLibrary('${libKey}')" class="flex-1 text-[10px] px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 transition">Del</button>
                </div>
            ` : ''}
        `;
        list.appendChild(div);
    });
}

function renderMobileLibraryDropdown() {
    const dropdown = document.getElementById('mobile-library-dropdown');
    dropdown.innerHTML = '';

    Object.keys(DATA.libraries).forEach(libKey => {
        const lib = DATA.libraries[libKey];
        const option = document.createElement('option');
        option.value = libKey;
        option.textContent = `${lib.icon} ${lib.name}`;
        option.selected = libKey === DATA.currentLibrary;
        dropdown.appendChild(option);
    });
}

function renderCategories() {
    const container = document.getElementById('sections-container');
    container.innerHTML = '';

    const currentLib = getCurrentLibrary();
    if (!currentLib || !currentLib.categories) return;

    const searchAll = document.getElementById('search-all-libraries')?.checked;

    // Determine which categories to show
    let categoriesToRender = [];

    if (searchAll) {
        // Show categories from all libraries
        Object.keys(DATA.libraries).forEach(libKey => {
            const lib = DATA.libraries[libKey];
            Object.keys(lib.categories || {}).forEach(catKey => {
                categoriesToRender.push({ libKey, catKey, category: lib.categories[catKey] });
            });
        });
    } else {
        // Show only current library's categories
        Object.keys(currentLib.categories).forEach(catKey => {
            categoriesToRender.push({
                libKey: DATA.currentLibrary,
                catKey,
                category: currentLib.categories[catKey]
            });
        });
    }

    // Apply focus filter
    if (focusCategory) {
        categoriesToRender = categoriesToRender.filter(item => item.catKey === focusCategory);
    }

    if (categoriesToRender.length === 0) {
        container.innerHTML = `
            <div class="glass rounded-3xl p-12 text-center">
                <p class="text-slate-500">No hay categor√≠as en esta librer√≠a.</p>
                <button onclick="openCategoryModal()" class="mt-4 px-6 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-medium transition">+ Crear Categor√≠a</button>
            </div>
        `;
        return;
    }

    categoriesToRender.forEach(({ libKey, catKey, category: s }) => {
        const isOpen = openSections.has(catKey);
        const div = document.createElement('div');
        div.className = `glass rounded-3xl overflow-hidden border-l-[6px] shadow-lg mb-6 transition-all`;
        div.style.borderColor = s.color;

        div.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-6 cursor-pointer hover:bg-white/[0.02] transition" onclick="toggleSectionDisplay('${catKey}')">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl">${s.icon}</span>
                        <h2 class="text-xl font-bold text-white uppercase tracking-tight">${s.name}</h2>
                        ${s.progress ? `<span class="text-[10px] bg-blue-500/20 px-2 py-0.5 rounded text-blue-400 font-bold border border-blue-500/30 uppercase">${s.progress}</span>` : ''}
                        ${searchAll ? `<span class="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-slate-400">${DATA.libraries[libKey].icon} ${DATA.libraries[libKey].name}</span>` : ''}
                    </div>
                    ${s.description ? `<p class="text-xs text-slate-500 ml-12 mt-1 line-clamp-1">${s.description}</p>` : ''}
                </div>
                <div class="flex items-center gap-3 mt-4 md:mt-0" onclick="event.stopPropagation()">
                    <button class="px-4 py-2 rounded-xl text-xs font-bold text-blue-400 bg-blue-400/10 hover:bg-blue-400/20 transition" onclick="addLink('${libKey}', '${catKey}')">+ LINK</button>
                    <button class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-700 transition" onclick="toggleFocus('${catKey}')">${focusCategory===catKey?'EXIT':'FOCUS'}</button>
                    ${manageCategories ? `
                        <button class="px-3 py-2 rounded-xl text-xs font-bold bg-white/10 hover:bg-white/20 transition" onclick="openCategoryModal('${libKey}', '${catKey}')">EDIT</button>
                        <button class="px-3 py-2 rounded-xl text-xs font-bold bg-red-500/20 text-red-500 hover:bg-red-500/30 transition" onclick="deleteCategory('${libKey}', '${catKey}')">DEL</button>
                    ` : ''}
                </div>
            </div>

            <div class="${isOpen ? '' : 'hidden'} p-6 pt-0 bg-black/10 border-t border-white/5 transition-all">
                <div class="mb-6 p-5 rounded-2xl bg-white/[0.03] border border-white/5 flex items-center gap-4 mt-6 group" onclick="event.stopPropagation()">
                    <div class="w-1.5 h-10 rounded-full" style="background:${s.color}"></div>
                    <div class="flex-1">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Nota de categor√≠a</p>
                        <input class="w-full bg-transparent text-sm font-medium text-white outline-none focus:text-blue-400 transition"
                               value="${s.task || ''}" placeholder="Nota general de esta categor√≠a..."
                               onkeydown="if(event.key==='Enter') { saveTask('${libKey}', '${catKey}', this.value); this.blur(); }"
                               onblur="saveTask('${libKey}', '${catKey}', this.value)">
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    ${renderLinks(libKey, catKey)}
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function renderLinks(libKey, catKey) {
    const category = DATA.libraries[libKey]?.categories[catKey];
    if (!category) return '';

    const links = category.links || [];
    const taskText = (category.task || '').toLowerCase().trim();
    const taskWords = taskText.split(/\s+/).filter(w => w.length > 2);

    if (!links.length) return `<div class="col-span-full py-6 text-center text-slate-600 italic">Lista vac√≠a.</div>`;

    return links.map((l, i) => {
        const titleMatch = taskWords.some(word => l.title.toLowerCase().includes(word));
        const descMatch = taskWords.some(word => (l.description || '').toLowerCase().includes(word));
        const isSmart = taskWords.length > 0 && (titleMatch || descMatch);
        const embed = getEmbedInfo(l.url);
        const pid = `${libKey}-${catKey}-${i}`;

        // Ensure status object exists with all fields
        if (!l.status) {
            l.status = { watching: false, watched: false, understood: false, applied: false };
        }

        let cardClass = "glass-card p-4 rounded-2xl border flex flex-col gap-4 group ";
        if (isSmart) cardClass += "smart-highlight";

        const statusBadge = getStatusBadge(l.status);

        return `
        <div class="${cardClass}" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start gap-3">
                <div class="flex items-start gap-3 flex-1 min-w-0">
                    <img src="${l.icon || 'https://www.google.com/s2/favicons?sz=64&domain=' + l.url}" class="w-10 h-10 rounded-lg bg-slate-800 object-contain p-1 border border-white/5 shadow-inner flex-shrink-0">
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                            <a href="${l.url}" target="_blank" class="text-sm font-bold text-blue-400 hover:underline truncate">
                                ${l.title}
                            </a>
                            ${statusBadge}
                        </div>
                        <p class="text-[10px] text-slate-500 truncate mt-0.5">${l.description || 'Sin detalles'}</p>

                        <!-- Inline Status (4 checkboxes) -->
                        <div class="flex items-center gap-3 mt-2 flex-wrap">
                            <label class="flex items-center gap-1 cursor-pointer text-[10px]">
                                <input type="checkbox" class="status-checkbox watching" ${l.status.watching ? 'checked' : ''} onchange="toggleLinkStatus('${libKey}', '${catKey}', ${i}, 'watching', this.checked)">
                                <span class="${l.status.watching ? 'text-yellow-400' : 'text-slate-500'}">üü°</span>
                            </label>
                            <label class="flex items-center gap-1 cursor-pointer text-[10px]">
                                <input type="checkbox" class="status-checkbox watched" ${l.status.watched ? 'checked' : ''} onchange="toggleLinkStatus('${libKey}', '${catKey}', ${i}, 'watched', this.checked)">
                                <span class="${l.status.watched ? 'text-blue-400' : 'text-slate-500'}">üîµ</span>
                            </label>
                            <label class="flex items-center gap-1 cursor-pointer text-[10px]">
                                <input type="checkbox" class="status-checkbox understood" ${l.status.understood ? 'checked' : ''} onchange="toggleLinkStatus('${libKey}', '${catKey}', ${i}, 'understood', this.checked)">
                                <span class="${l.status.understood ? 'text-emerald-400' : 'text-slate-500'}">üü¢</span>
                            </label>
                            <label class="flex items-center gap-1 cursor-pointer text-[10px]">
                                <input type="checkbox" class="status-checkbox applied" ${l.status.applied ? 'checked' : ''} onchange="toggleLinkStatus('${libKey}', '${catKey}', ${i}, 'applied', this.checked)">
                                <span class="${l.status.applied ? 'text-amber-400' : 'text-slate-500'}">‚≠ê</span>
                            </label>
                        </div>

                        <!-- Quick Note Display -->
                        ${l.quickNote ? `<p class="text-[10px] text-slate-400 mt-2 italic truncate">üìù ${l.quickNote}</p>` : ''}
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2 opacity-0 group-hover:opacity-100 transition-all">
                    <button class="text-blue-400/60 hover:text-blue-400 transition" onclick="editLink('${libKey}', '${catKey}', ${i})" title="Editar">‚úèÔ∏è</button>
                    <button class="text-red-500/40 hover:text-red-500 transition" onclick="deleteLink('${libKey}', '${catKey}', ${i})" title="Eliminar">üóëÔ∏è</button>
                </div>
            </div>
            ${embed ? `
                <div class="flex gap-2">
                    <button class="flex-1 py-1.5 rounded-lg bg-white/5 text-[9px] font-bold text-slate-500 uppercase hover:bg-white/10 transition" onclick="togglePreview('${pid}', '${embed.type}', '${embed.src}')">Ver Preview</button>
                    <button class="px-3 py-1.5 rounded-lg bg-purple-500/20 text-[9px] font-bold text-purple-400 uppercase hover:bg-purple-500/30 transition" onclick="openVideoFocusModal('${libKey}', '${catKey}', ${i}, '${embed.type}', '${embed.src}')">üé¨ Focus</button>
                </div>
                <div id="preview-${pid}"></div>
            ` : ''}
        </div>`;
    }).join('');
}

// ================= LINK STATUS FUNCTIONS =================
function toggleLinkStatus(libKey, catKey, linkIndex, field, value) {
    const link = DATA.libraries[libKey]?.categories[catKey]?.links[linkIndex];
    if (!link) return;

    if (!link.status) link.status = { watching: false, watched: false, understood: false, applied: false };
    link.status[field] = value;

    save();
    render();
    showToast('üíæ Guardado', false);
}

function saveLinkNote(libKey, catKey, linkIndex, note) {
    const link = DATA.libraries[libKey]?.categories[catKey]?.links[linkIndex];
    if (!link) return;

    link.quickNote = note.substring(0, 100);
    save();
    showToast('üíæ Guardado', false);
}

// ================= VIDEO FOCUS MODE =================
function openVideoFocusModal(libKey, catKey, linkIndex, type, src) {
    focusLibrary = libKey;
    focusCategory2 = catKey;
    focusLinkIndex = linkIndex;

    loadVideoInFocusMode(libKey, catKey, linkIndex, type, src);

    // Show modal
    document.getElementById('video-focus-modal').classList.add('modal-active');

    // Add ESC listener
    document.addEventListener('keydown', handleFocusEsc);
}

function loadVideoInFocusMode(libKey, catKey, linkIndex, type, src) {
    const link = DATA.libraries[libKey]?.categories[catKey]?.links[linkIndex];
    if (!link) return;

    const lib = DATA.libraries[libKey];
    const cat = lib?.categories[catKey];

    // Update state
    focusLibrary = libKey;
    focusCategory2 = catKey;
    focusLinkIndex = linkIndex;

    // Set title
    document.getElementById('video-focus-title').textContent = link.title || 'Video';

    // Set library and category info
    document.getElementById('focus-lib-icon').textContent = lib?.icon || 'üìö';
    document.getElementById('focus-lib-name').textContent = lib?.name || 'Library';
    document.getElementById('focus-cat-name').textContent = cat?.name || 'Category';

    // Set status checkboxes (4 states)
    if (!link.status) link.status = { watching: false, watched: false, understood: false, applied: false };
    document.getElementById('focus-watching').checked = link.status.watching || false;
    document.getElementById('focus-watched').checked = link.status.watched || false;
    document.getElementById('focus-understood').checked = link.status.understood || false;
    document.getElementById('focus-applied').checked = link.status.applied || false;

    // Set full note
    const fullNoteEl = document.getElementById('focus-full-note');
    fullNoteEl.value = link.fullNote || '';
    document.getElementById('full-note-char-count').textContent = (link.fullNote || '').length;
    document.getElementById('focus-save-status').textContent = '';

    // Set link URL
    document.getElementById('focus-link-url').href = link.url;

    // Set video player
    const playerContainer = document.getElementById('video-focus-player');
    if (type === 'youtube') {
        playerContainer.innerHTML = `<iframe class="w-full h-full" src="${src}?autoplay=1" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;
    } else {
        playerContainer.innerHTML = `<video controls autoplay class="w-full h-full" src="${src}"></video>`;
    }

    // Populate next videos
    populateNextVideos(libKey, catKey, linkIndex);
}

function populateNextVideos(libKey, catKey, currentIndex) {
    const container = document.getElementById('focus-next-videos');
    container.innerHTML = '';

    const category = DATA.libraries[libKey]?.categories[catKey];
    if (!category || !category.links) {
        container.innerHTML = '<p class="text-slate-500 text-xs text-center py-4">No hay m√°s videos</p>';
        return;
    }

    const links = category.links;
    let videosAdded = 0;
    const maxVideos = 5;

    // Find videos with embeds (starting from current index + 1, wrapping around)
    for (let offset = 1; offset <= links.length && videosAdded < maxVideos; offset++) {
        const idx = (currentIndex + offset) % links.length;
        if (idx === currentIndex) continue;

        const link = links[idx];
        const embed = getEmbedInfo(link.url);

        if (embed) {
            const isCurrent = idx === currentIndex;
            const ytId = getYouTubeVideoId(link.url);
            const thumbnail = ytId ? `https://img.youtube.com/vi/${ytId}/mqdefault.jpg` : '';

            container.innerHTML += `
                <div class="next-video-item p-2 rounded-lg border border-transparent ${isCurrent ? 'current' : ''} flex items-center gap-3" onclick="navigateToVideo('${libKey}', '${catKey}', ${idx}, '${embed.type}', '${embed.src}')">
                    ${thumbnail ? `<img src="${thumbnail}" class="w-16 h-10 rounded object-cover flex-shrink-0 bg-slate-700">` : `<div class="w-16 h-10 rounded bg-slate-700 flex items-center justify-center text-slate-500">‚ñ∂</div>`}
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-white truncate font-medium">${link.title}</p>
                        ${getStatusBadge(link.status) || '<span class="text-[10px] text-slate-500">Sin ver</span>'}
                    </div>
                </div>
            `;
            videosAdded++;
        }
    }

    if (videosAdded === 0) {
        container.innerHTML = '<p class="text-slate-500 text-xs text-center py-4">No hay m√°s videos</p>';
    }
}

function navigateToVideo(libKey, catKey, linkIndex, type, src) {
    // Save current state first
    saveCurrentFocusState();

    // Load new video
    loadVideoInFocusMode(libKey, catKey, linkIndex, type, src);
}

function saveCurrentFocusState() {
    if (focusLibrary === null) return;

    const link = DATA.libraries[focusLibrary]?.categories[focusCategory2]?.links[focusLinkIndex];
    if (!link) return;

    // Save status
    if (!link.status) link.status = { watching: false, watched: false, understood: false, applied: false };
    link.status.watching = document.getElementById('focus-watching').checked;
    link.status.watched = document.getElementById('focus-watched').checked;
    link.status.understood = document.getElementById('focus-understood').checked;
    link.status.applied = document.getElementById('focus-applied').checked;

    // Save full note
    link.fullNote = document.getElementById('focus-full-note').value.substring(0, 500);

    save();
}

function closeVideoFocusModal() {
    // Save current state before closing
    saveCurrentFocusState();

    document.getElementById('video-focus-modal').classList.remove('modal-active');
    document.getElementById('video-focus-player').innerHTML = '';
    document.removeEventListener('keydown', handleFocusEsc);

    focusLibrary = null;
    focusCategory2 = null;
    focusLinkIndex = null;

    render();
}

function handleFocusEsc(e) {
    if (e.key === 'Escape') closeVideoFocusModal();
}

function updateFocusStatus() {
    if (focusLibrary === null) return;

    const link = DATA.libraries[focusLibrary]?.categories[focusCategory2]?.links[focusLinkIndex];
    if (!link) return;

    if (!link.status) link.status = { watching: false, watched: false, understood: false, applied: false };
    link.status.watching = document.getElementById('focus-watching').checked;
    link.status.watched = document.getElementById('focus-watched').checked;
    link.status.understood = document.getElementById('focus-understood').checked;
    link.status.applied = document.getElementById('focus-applied').checked;

    save();
    showFocusSaveIndicator();
}

function debounceSaveFullNote() {
    const noteEl = document.getElementById('focus-full-note');
    document.getElementById('full-note-char-count').textContent = noteEl.value.length;
    document.getElementById('focus-save-status').textContent = '‚è≥ Guardando...';

    clearTimeout(fullNoteDebounceTimer);
    fullNoteDebounceTimer = setTimeout(() => {
        if (focusLibrary === null) return;

        const link = DATA.libraries[focusLibrary]?.categories[focusCategory2]?.links[focusLinkIndex];
        if (!link) return;

        link.fullNote = noteEl.value.substring(0, 500);
        // Also save as quickNote (first 100 chars) for display in cards
        link.quickNote = noteEl.value.substring(0, 100);
        save();
        showFocusSaveIndicator();
    }, 2000);
}

function showFocusSaveIndicator() {
    document.getElementById('focus-save-status').textContent = 'üíæ Guardado';
    setTimeout(() => {
        const el = document.getElementById('focus-save-status');
        if (el) el.textContent = '';
    }, 2000);
}

// ================= LOGICA =================
function toggleSectionDisplay(k) {
    if (openSections.has(k)) openSections.delete(k);
    else openSections.add(k);
    render();
}

function saveTask(libKey, catKey, val) {
    if (DATA.libraries[libKey]?.categories[catKey]) {
        DATA.libraries[libKey].categories[catKey].task = val;
        save();
        render();
    }
}

function toggleFocus(k) {
    focusCategory = (focusCategory === k) ? null : k;
    render();
}

function toggleManageCategories() {
    manageCategories = !manageCategories;
    render();
}

function deleteCategory(libKey, catKey) {
    if (confirm(`¬øBorrar categor√≠a completa?`)) {
        delete DATA.libraries[libKey].categories[catKey];
        save();
        render();
    }
}

let editingLibKey = null;

function openCategoryModal(libKey = null, catKey = null) {
    editingLibKey = libKey || DATA.currentLibrary;
    editingCategoryKey = catKey;

    const category = catKey ? DATA.libraries[editingLibKey]?.categories[catKey] : null;

    document.getElementById('category-modal-title').textContent = catKey ? 'Editar Categor√≠a' : 'Nueva Categor√≠a';
    document.getElementById('cat-name').value = category ? category.name : '';
    document.getElementById('cat-progress').value = category ? category.progress : '';
    document.getElementById('cat-desc').value = category ? category.description : '';

    renderPickers(category ? category.icon : 'üìÅ', category ? category.color : '#4a9eff');
    document.getElementById('category-modal').classList.add('modal-active');
}

function renderPickers(selI, selC) {
    const ig = document.getElementById('icon-grid');
    ig.innerHTML = '';
    ICONS.forEach(i => {
        const d = document.createElement('div');
        d.className = `cursor-pointer p-2 rounded-xl text-xl bg-white/5 hover:bg-white/10 ${i===selI ? 'ring-2 ring-blue-500' : ''}`;
        d.textContent = i;
        d.onclick = () => renderPickers(i, selC);
        ig.appendChild(d);
        if (i===selI) d.id = "selected-icon";
    });
    const cg = document.getElementById('color-grid');
    cg.innerHTML = '';
    COLORS.forEach(c => {
        const d = document.createElement('div');
        d.className = `w-8 h-8 rounded-full cursor-pointer border-2 transition hover:scale-110 ${c===selC ? 'border-white' : 'border-transparent'}`;
        d.style.background = c;
        d.onclick = () => renderPickers(selI, c);
        cg.appendChild(d);
        if (c===selC) d.id = "selected-color";
    });
}

function saveCategory() {
    const name = document.getElementById('cat-name').value.trim();
    if (!name) return;

    const data = {
        name,
        icon: document.getElementById('selected-icon').textContent,
        color: document.getElementById('selected-color').style.backgroundColor,
        progress: document.getElementById('cat-progress').value,
        description: document.getElementById('cat-desc').value,
        links: editingCategoryKey ? DATA.libraries[editingLibKey].categories[editingCategoryKey].links : [],
        task: editingCategoryKey ? DATA.libraries[editingLibKey].categories[editingCategoryKey].task : ''
    };

    if (editingCategoryKey) {
        DATA.libraries[editingLibKey].categories[editingCategoryKey] = data;
    } else {
        DATA.libraries[editingLibKey].categories['cat_' + Date.now()] = data;
    }

    save();
    closeCategoryModal();
    render();
}

function closeCategoryModal() {
    document.getElementById('category-modal').classList.remove('modal-active');
}

let activeLinkLibKey = null;

function addLink(libKey, catKey) {
    activeLinkLibKey = libKey;
    activeCategory = catKey;
    editingLinkIndex = null;
    document.getElementById('link-modal-title').textContent = 'Nuevo Link';
    document.getElementById('link-url').value = "";
    document.getElementById('link-title').value = '';
    document.getElementById('link-desc').value = '';
    document.getElementById('link-icon-preview').src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
    document.getElementById('auto-status').innerText = "";
    document.getElementById('link-modal').classList.add('modal-active');
}

function editLink(libKey, catKey, i) {
    activeLinkLibKey = libKey;
    activeCategory = catKey;
    editingLinkIndex = i;
    const link = DATA.libraries[libKey].categories[catKey].links[i];
    document.getElementById('link-modal-title').textContent = 'Editar Link';
    document.getElementById('link-url').value = link.url || '';
    document.getElementById('link-title').value = link.title || '';
    document.getElementById('link-desc').value = link.description || '';
    document.getElementById('link-icon-preview').src = link.icon || "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
    document.getElementById('auto-status').innerText = "";
    document.getElementById('link-modal').classList.add('modal-active');
}

function saveLink() {
    const existingLink = editingLinkIndex !== null
        ? DATA.libraries[activeLinkLibKey].categories[activeCategory].links[editingLinkIndex]
        : null;

    const l = {
        url: document.getElementById('link-url').value,
        title: document.getElementById('link-title').value || 'Sin T√≠tulo',
        description: document.getElementById('link-desc').value,
        icon: document.getElementById('link-icon-preview').src,
        status: existingLink?.status || { watching: false, watched: false, understood: false, applied: false },
        quickNote: existingLink?.quickNote || '',
        fullNote: existingLink?.fullNote || ''
    };

    if (!l.url) return;

    if (editingLinkIndex !== null) {
        DATA.libraries[activeLinkLibKey].categories[activeCategory].links[editingLinkIndex] = l;
    } else {
        DATA.libraries[activeLinkLibKey].categories[activeCategory].links.push(l);
    }

    save();
    closeLinkModal();
    render();
}

function closeLinkModal() {
    document.getElementById('link-modal').classList.remove('modal-active');
}

function deleteLink(libKey, catKey, i) {
    if (confirm('¬øBorrar link?')) {
        DATA.libraries[libKey].categories[catKey].links.splice(i, 1);
        save();
        render();
    }
}

function getYouTubeVideoId(url) {
    try {
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.replace('/','');
        if (u.hostname.includes('youtube.com')) return u.searchParams.get('v');
    } catch(e) {}
    return null;
}

function getEmbedInfo(url) {
    const ytId = getYouTubeVideoId(url);
    if (ytId) return { type:'youtube', src:`https://www.youtube-nocookie.com/embed/${ytId}` };
    if (url.match(/\.(mp4|webm)$/i)) return { type:'file', src:url };
    return null;
}

function togglePreview(id, type, src) {
    const el = document.getElementById(`preview-${id}`);
    if (el.innerHTML) { el.innerHTML = ''; return; }
    el.innerHTML = `<div class="aspect-video bg-black rounded-xl overflow-hidden mt-3 border border-white/10">${type === 'file' ? `<video controls class="w-full h-full" src="${src}"></video>` : `<iframe class="w-full h-full" src="${src}" allowfullscreen></iframe>`}</div>`;
}

// ================= EXPORT/IMPORT =================
let importData = null;
let importConflicts = {};

function showToast(message, isError = false) {
    const toast = document.getElementById('toast-notification');
    const icon = document.getElementById('toast-icon');
    const msg = document.getElementById('toast-message');

    icon.textContent = isError ? '‚ùå' : '‚úÖ';
    msg.textContent = message;
    toast.classList.remove('bg-emerald-600', 'bg-red-600');
    toast.classList.add(isError ? 'bg-red-600' : 'bg-emerald-600');

    toast.classList.remove('translate-y-20', 'opacity-0');
    toast.classList.add('translate-y-0', 'opacity-100');

    setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
        toast.classList.remove('translate-y-0', 'opacity-100');
    }, 3000);
}

// ===== EXPORT =====
function openExportModal() {
    const list = document.getElementById('export-categories-list');
    list.innerHTML = '';

    Object.keys(DATA.libraries).forEach(libKey => {
        const lib = DATA.libraries[libKey];
        const catKeys = Object.keys(lib.categories || {});

        // Library header
        list.innerHTML += `
            <div class="p-3 rounded-xl bg-slate-700/30 border border-slate-600/50 mb-2">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" class="export-lib-checkbox w-5 h-5 rounded accent-blue-500" data-lib-key="${libKey}" checked onchange="toggleLibraryExport('${libKey}', this.checked)" />
                    <span class="text-xl">${lib.icon}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium">${lib.name}</p>
                        <p class="text-slate-500 text-xs">${catKeys.length} categor√≠a(s)</p>
                    </div>
                </label>
                <div class="ml-8 mt-2 space-y-1" id="export-lib-${libKey}">
                    ${catKeys.map(catKey => {
                        const cat = lib.categories[catKey];
                        const linksCount = cat.links?.length || 0;
                        return `
                            <label class="flex items-center gap-2 p-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 cursor-pointer transition text-sm">
                                <input type="checkbox" class="export-cat-checkbox w-4 h-4 rounded accent-blue-500" data-lib-key="${libKey}" data-cat-key="${catKey}" checked />
                                <span>${cat.icon}</span>
                                <span class="text-slate-300 truncate flex-1">${cat.name}</span>
                                <span class="text-slate-500 text-xs">${linksCount} links</span>
                            </label>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });

    if (Object.keys(DATA.libraries).length === 0) {
        list.innerHTML = '<p class="text-slate-500 text-center py-4">No hay datos para exportar</p>';
    }

    document.getElementById('export-modal').classList.add('modal-active');
}

function toggleLibraryExport(libKey, checked) {
    document.querySelectorAll(`#export-lib-${libKey} .export-cat-checkbox`).forEach(cb => {
        cb.checked = checked;
    });
}

function closeExportModal() {
    document.getElementById('export-modal').classList.remove('modal-active');
}

function selectAllExport(select) {
    document.querySelectorAll('.export-lib-checkbox, .export-cat-checkbox').forEach(cb => cb.checked = select);
}

function executeExport() {
    const exportData = {
        version: "3.0",
        exportDate: new Date().toISOString(),
        libraries: {}
    };

    // Collect selected libraries and categories
    document.querySelectorAll('.export-lib-checkbox:checked').forEach(libCb => {
        const libKey = libCb.dataset.libKey;
        const lib = DATA.libraries[libKey];

        exportData.libraries[libKey] = {
            name: lib.name,
            icon: lib.icon,
            categories: {}
        };

        document.querySelectorAll(`.export-cat-checkbox[data-lib-key="${libKey}"]:checked`).forEach(catCb => {
            const catKey = catCb.dataset.catKey;
            exportData.libraries[libKey].categories[catKey] = lib.categories[catKey];
        });
    });

    const totalLibs = Object.keys(exportData.libraries).length;
    let totalCats = 0;
    Object.values(exportData.libraries).forEach(lib => {
        totalCats += Object.keys(lib.categories).length;
    });

    if (totalLibs === 0) {
        showToast('Selecciona al menos una librer√≠a', true);
        return;
    }

    exportData.totalLibraries = totalLibs;
    exportData.totalCategories = totalCats;

    // Generate filename
    const date = new Date();
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    const filename = `tab-organizer-export-${dateStr}.json`;

    // Download file
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    closeExportModal();
    showToast(`Exportadas ${totalLibs} librer√≠a(s) con ${totalCats} categor√≠a(s)`);
}

// ===== IMPORT =====
function openImportModal() {
    document.getElementById('import-file-input').value = '';
    document.getElementById('import-error').classList.add('hidden');
    document.getElementById('import-modal').classList.add('modal-active');
}

function closeImportModal() {
    document.getElementById('import-modal').classList.remove('modal-active');
}

function showImportError(message) {
    const el = document.getElementById('import-error');
    el.textContent = message;
    el.classList.remove('hidden');
}

function validateUrl(url) {
    try {
        new URL(url);
        return true;
    } catch {
        return false;
    }
}

function migrateLinkForImport(link) {
    // Ensure all fields exist for imported links
    return {
        url: link.url,
        title: link.title,
        description: link.description || '',
        icon: link.icon,
        status: {
            watching: link.status?.watching || false,
            watched: link.status?.watched || link.isWatching || false,
            understood: link.status?.understood || false,
            applied: link.status?.applied || false
        },
        quickNote: link.quickNote || '',
        fullNote: link.fullNote || ''
    };
}

function handleImportFile(file) {
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            // Check if it's old format (v1) or new format (v2/v3)
            if (data.categories && !data.libraries) {
                // Old format - convert to new format for import
                data.libraries = {
                    ['imported_' + Date.now()]: {
                        name: 'Importado',
                        icon: 'üì•',
                        categories: {}
                    }
                };

                Object.keys(data.categories).forEach(catKey => {
                    const cat = data.categories[catKey];
                    // Migrate links to new format
                    const migratedLinks = (cat.links || []).map(migrateLinkForImport);

                    data.libraries[Object.keys(data.libraries)[0]].categories[catKey] = {
                        ...cat,
                        links: migratedLinks
                    };
                });

                delete data.categories;
                data.version = "3.0";
            } else if (data.libraries) {
                // Migrate links in v2/v3 format to ensure all fields exist
                Object.keys(data.libraries).forEach(libKey => {
                    const lib = data.libraries[libKey];
                    Object.keys(lib.categories || {}).forEach(catKey => {
                        const cat = lib.categories[catKey];
                        cat.links = (cat.links || []).map(migrateLinkForImport);
                    });
                });
            }

            // Validate new format structure
            if (!data.libraries || typeof data.libraries !== 'object') {
                showImportError('Archivo inv√°lido: estructura no reconocida');
                return;
            }

            importData = data;
            closeImportModal();
            showImportPreview();

        } catch (err) {
            showImportError('Error al parsear JSON: ' + err.message);
        }
    };

    reader.onerror = function() {
        showImportError('Error al leer el archivo');
    };

    reader.readAsText(file);
}

function showImportPreview() {
    if (!importData) return;

    importConflicts = {};

    let totalLibs = Object.keys(importData.libraries).length;
    let totalCats = 0;
    let totalLinks = 0;

    Object.values(importData.libraries).forEach(lib => {
        const cats = Object.keys(lib.categories || {}).length;
        totalCats += cats;
        Object.values(lib.categories || {}).forEach(cat => {
            totalLinks += (cat.links || []).length;
        });
    });

    // Update summary
    const summary = document.getElementById('import-summary');
    summary.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <span class="text-slate-400">Versi√≥n:</span>
            <span class="text-white font-medium">${importData.version || '1.0'}</span>
        </div>
        <div class="flex justify-between items-center mb-2">
            <span class="text-slate-400">Fecha exportaci√≥n:</span>
            <span class="text-white font-medium">${importData.exportDate ? new Date(importData.exportDate).toLocaleDateString() : 'N/A'}</span>
        </div>
        <div class="flex justify-between items-center mb-2">
            <span class="text-slate-400">Librer√≠as:</span>
            <span class="text-white font-medium">${totalLibs}</span>
        </div>
        <div class="flex justify-between items-center mb-2">
            <span class="text-slate-400">Categor√≠as:</span>
            <span class="text-white font-medium">${totalCats}</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-slate-400">Links totales:</span>
            <span class="text-white font-medium">${totalLinks}</span>
        </div>
    `;

    // Check for conflicts (libraries with same name)
    const existingLibNames = {};
    Object.keys(DATA.libraries).forEach(key => {
        existingLibNames[DATA.libraries[key].name.toLowerCase()] = key;
    });

    const newLibraries = [];
    const conflicts = [];

    Object.keys(importData.libraries).forEach(importKey => {
        const lib = importData.libraries[importKey];
        const nameLower = lib.name.toLowerCase();

        if (existingLibNames[nameLower]) {
            conflicts.push({
                importKey,
                existingKey: existingLibNames[nameLower],
                name: lib.name,
                catCount: Object.keys(lib.categories || {}).length
            });
            importConflicts[importKey] = 'merge';
        } else {
            newLibraries.push({
                importKey,
                name: lib.name,
                icon: lib.icon,
                catCount: Object.keys(lib.categories || {}).length
            });
        }
    });

    // Show new libraries
    const newSection = document.getElementById('import-new-section');
    const newList = document.getElementById('import-new-list');
    if (newLibraries.length > 0) {
        newSection.classList.remove('hidden');
        newList.innerHTML = newLibraries.map(lib => `
            <div class="flex items-center gap-3 p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20">
                <span class="text-xl">${lib.icon || 'üìÅ'}</span>
                <div class="flex-1 min-w-0">
                    <p class="text-white font-medium truncate">${lib.name}</p>
                    <p class="text-emerald-400 text-xs">${lib.catCount} categor√≠a(s)</p>
                </div>
                <span class="text-emerald-400 text-xs font-bold">NUEVA</span>
            </div>
        `).join('');
    } else {
        newSection.classList.add('hidden');
    }

    // Show conflicts
    const conflictsSection = document.getElementById('import-conflicts-section');
    const conflictsList = document.getElementById('import-conflicts-list');
    if (conflicts.length > 0) {
        conflictsSection.classList.remove('hidden');
        conflictsList.innerHTML = conflicts.map(conf => `
            <div class="p-4 rounded-xl bg-amber-500/10 border border-amber-500/20">
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-xl">${importData.libraries[conf.importKey].icon || 'üìÅ'}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium truncate">${conf.name}</p>
                        <p class="text-amber-400 text-xs">${conf.catCount} categor√≠a(s)</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <label class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800 cursor-pointer hover:bg-slate-700 transition text-xs">
                        <input type="radio" name="conflict-${conf.importKey}" value="merge" checked onchange="importConflicts['${conf.importKey}']='merge'" class="accent-blue-500" />
                        <span class="text-slate-300">Fusionar categor√≠as</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800 cursor-pointer hover:bg-slate-700 transition text-xs">
                        <input type="radio" name="conflict-${conf.importKey}" value="rename" onchange="importConflicts['${conf.importKey}']='rename'" class="accent-amber-500" />
                        <span class="text-slate-300">Crear como nueva</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800 cursor-pointer hover:bg-slate-700 transition text-xs">
                        <input type="radio" name="conflict-${conf.importKey}" value="skip" onchange="importConflicts['${conf.importKey}']='skip'" class="accent-red-500" />
                        <span class="text-slate-300">Saltar</span>
                    </label>
                </div>
            </div>
        `).join('');
    } else {
        conflictsSection.classList.add('hidden');
    }

    document.getElementById('import-preview-modal').classList.add('modal-active');
}

function closeImportPreviewModal() {
    document.getElementById('import-preview-modal').classList.remove('modal-active');
    importData = null;
    importConflicts = {};
}

async function executeImport() {
    if (!importData) return;

    // Map existing library names to keys
    const existingLibNames = {};
    Object.keys(DATA.libraries).forEach(key => {
        existingLibNames[DATA.libraries[key].name.toLowerCase()] = key;
    });

    let imported = 0;
    let skipped = 0;

    Object.keys(importData.libraries).forEach(importKey => {
        const lib = importData.libraries[importKey];
        const nameLower = lib.name.toLowerCase();
        const existingKey = existingLibNames[nameLower];

        if (existingKey) {
            const resolution = importConflicts[importKey] || 'merge';

            if (resolution === 'skip') {
                skipped++;
                return;
            }

            if (resolution === 'merge') {
                // Merge categories into existing library
                Object.keys(lib.categories || {}).forEach(catKey => {
                    const newCatKey = 'cat_imported_' + Date.now() + '_' + catKey;
                    DATA.libraries[existingKey].categories[newCatKey] = lib.categories[catKey];
                });
                imported++;
                return;
            }

            if (resolution === 'rename') {
                // Create as new library with modified name
                const newKey = 'lib_imported_' + Date.now();
                DATA.libraries[newKey] = {
                    ...lib,
                    name: lib.name + ' (importado)'
                };
                imported++;
                return;
            }
        } else {
            // New library, add directly
            const newKey = 'lib_imported_' + Date.now() + '_' + importKey;
            DATA.libraries[newKey] = { ...lib };
            imported++;
        }
    });

    await save();
    render();

    closeImportPreviewModal();
    showToast(`Importaci√≥n completada: ${imported} librer√≠a(s)${skipped > 0 ? `, ${skipped} saltada(s)` : ''}`);
}

// INICIO
ensureDataStructure();
initAuth();
render();
</script>
</body>
</html>
