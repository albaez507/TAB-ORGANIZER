<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tab Organizer Ultra - Full Features & Cloud</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: radial-gradient(circle at top left, #1e293b, #0f172a);
        min-height: 100vh;
        color: #cbd5e1;
    }
    .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .glass-card {
        background: rgba(255, 255, 255, 0.03);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
    }
    .glass-card:hover {
        transform: translateY(-4px) scale(1.01);
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 20px -10px rgba(0,0,0,0.5);
    }
    @keyframes modalIn {
        from { opacity: 0; transform: scale(0.9) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal-content { animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    
    .smart-highlight {
        background: rgba(59, 130, 246, 0.12) !important;
        border-color: rgba(59, 130, 246, 0.5) !important;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
    }
    .watching-now {
        background: rgba(34, 197, 94, 0.15) !important;
        border-color: rgba(34, 197, 94, 0.6) !important;
        box-shadow: 0 0 25px rgba(34, 197, 94, 0.25);
    }
    .modal-active { display: flex !important; }
    
    .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(14px); }

    .loading-pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
</style>
</head>
<body class="p-4 md:p-10">
<div class="max-w-5xl mx-auto">
<header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-12">
    <div>
        <h1 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
            <span class="bg-blue-600/20 p-2 rounded-xl border border-blue-500/20">üìë</span> Tab Organizer
        </h1>
        <p class="text-slate-500 text-sm mt-1">Tu centro de mando digital con IA de metadatos.</p>
    </div>
    <div class="flex flex-wrap gap-2 md:gap-3 text-white items-center justify-center md:justify-end">
        <span id="cloud-status" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest order-first w-full md:w-auto text-center md:text-left md:mr-2">Iniciando...</span>
        <div id="user-info" class="flex items-center gap-2">
            <span id="user-email" class="text-xs text-slate-400 hidden max-w-[120px] md:max-w-[180px] truncate"></span>
        </div>
        <button onclick="save()" title="Forzar Sincronizaci√≥n" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition">‚òÅÔ∏è</button>
        <button id="manageBtn" onclick="toggleManageCategories()" class="px-3 md:px-4 py-2 rounded-lg border border-slate-700 hover:bg-slate-800 transition text-sm font-medium">Gestionar</button>
        <button onclick="openCategoryModal()" class="px-3 md:px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white shadow-lg transition text-sm font-medium">+ Categor√≠a</button>
        <button id="auth-btn" onclick="handleAuth()" class="px-3 md:px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg transition text-sm font-medium">Login</button>
    </div>
</header>

<div id="sections-container" class="space-y-6"></div>

<!-- Pantalla de bienvenida para usuarios no logueados -->
<div id="welcome-screen" class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-md z-40 items-center justify-center p-4 overflow-y-auto">
    <div class="glass modal-content p-8 md:p-12 rounded-3xl max-w-lg text-center shadow-2xl my-8">
        <div class="text-6xl mb-6">üìë</div>
        <h2 class="text-3xl font-bold text-white mb-4">Tab Organizer</h2>
        <p class="text-slate-400 mb-8">Organiza todos tus links en un solo lugar.</p>

        <!-- Google OAuth -->
        <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-3 px-6 py-4 rounded-xl bg-white hover:bg-gray-100 text-slate-800 font-bold shadow-lg transition text-lg">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Continuar con Google
        </button>

        <!-- Separador -->
        <div class="flex items-center gap-4 my-6">
            <div class="flex-1 h-px bg-slate-700"></div>
            <span class="text-slate-500 text-sm">o</span>
            <div class="flex-1 h-px bg-slate-700"></div>
        </div>

        <!-- Email/Password Form -->
        <div class="space-y-3">
            <input id="auth-email" type="email" placeholder="Email" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition" />
            <input id="auth-password" type="password" placeholder="Contrase√±a" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition" />
            <p id="auth-error" class="text-red-400 text-xs hidden"></p>
            <div class="flex gap-3">
                <button onclick="signUpWithEmail()" class="flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg transition">
                    Crear cuenta
                </button>
                <button onclick="signInWithEmail()" class="flex-1 px-4 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg transition">
                    Iniciar sesi√≥n
                </button>
            </div>
        </div>

        <!-- Separador -->
        <div class="flex items-center gap-4 my-6">
            <div class="flex-1 h-px bg-slate-700"></div>
            <span class="text-slate-500 text-sm">o</span>
            <div class="flex-1 h-px bg-slate-700"></div>
        </div>

        <!-- Guest Mode -->
        <button onclick="enterGuestMode()" class="w-full flex flex-col items-center justify-center gap-1 px-6 py-4 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-bold shadow-lg transition">
            <span class="text-lg">üë§ Probar como invitado</span>
            <span class="text-[10px] text-slate-500 font-normal">(Sin sincronizaci√≥n en nube)</span>
        </button>

        <p class="text-slate-600 text-xs mt-6">Con Google o Email tus datos se sincronizan en la nube</p>
    </div>
</div>
</div>

<div id="link-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-md shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 id="link-modal-title" class="text-xl font-bold text-white">Nuevo Link</h3>
            <span id="auto-status" class="text-[10px] text-blue-400 font-bold uppercase"></span>
        </div>
        <div class="space-y-4">
            <input id="link-url" oninput="fetchMetadata(this.value)" placeholder="https://..." class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition" />
            
            <div class="flex gap-3 items-center bg-slate-900/50 p-2 rounded-xl border border-slate-800">
                <img id="link-icon-preview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="w-10 h-10 rounded-lg bg-slate-700 object-contain">
                <input id="link-title" placeholder="T√≠tulo (Autom√°tico)" class="flex-1 bg-transparent text-white outline-none font-medium text-sm" />
            </div>

            <textarea id="link-desc" placeholder="Descripci√≥n (Autom√°tica)" rows="3" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500 transition text-sm"></textarea>
            
            <div class="flex gap-3 pt-2">
                <button class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white hover:bg-blue-500 transition" onclick="saveLink()">Guardar Link</button>
                <button class="px-6 py-3 rounded-xl bg-slate-800 font-bold hover:bg-slate-700 transition" onclick="closeLinkModal()">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div id="category-modal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="glass modal-content p-8 rounded-3xl w-full max-w-md shadow-2xl">
        <h3 id="category-modal-title" class="text-xl font-bold text-white mb-6">Ajustes de Categor√≠a</h3>
        <div class="space-y-4 mb-6">
            <input id="cat-name" placeholder="Nombre" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-blue-500" />
            <input id="cat-progress" placeholder="Estado (Video 5...)" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-blue-400 text-sm outline-none" />
            <textarea id="cat-desc" placeholder="Descripci√≥n General" rows="2" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-slate-300 text-sm outline-none"></textarea>
        </div>
        <div class="flex flex-wrap gap-2 mb-6" id="icon-grid"></div>
        <div class="flex flex-wrap gap-2 mb-8" id="color-grid"></div>
        <div class="flex gap-3">
            <button class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white" onclick="saveCategory()">Guardar</button>
            <button class="px-6 py-3 rounded-xl bg-slate-800 font-bold" onclick="closeCategoryModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
// ================= CONFIG =================
const SUPABASE_URL = 'https://rdipxnnqljdgcfmdemzi.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkaXB4bm5xbGpkZ2NmbWRlbXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMzIyMzQsImV4cCI6MjA4MzkwODIzNH0.TSJFCV2DTzZchL_cLKPsMSB40bjbNuMW0ysVwf-Z7YA';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let SECTIONS = {};
let openSections = new Set();
let activeCategory = null, activeIndex = null, focusCategory = null, manageCategories = false, editingCategoryKey = null;
let editingLinkIndex = null; // Para editar links
let currentUser = null; // Usuario autenticado
let isGuest = false; // Modo invitado (solo localStorage)
const ICONS = ['üìÅ','üìö','üé¨','üß†','‚≠ê','üéØ','üõ†Ô∏è','üßæ','üí°','üìå','üóÇÔ∏è','üß©','üß™','üîñ'];
const COLORS = ['#4a9eff','#a78bfa','#fbbf24','#4ade80','#ef4444','#22d3ee','#f472b6'];

// ================= AUTENTICACI√ìN =================
async function initAuth() {
    // Escuchar cambios de autenticaci√≥n
    _supabase.auth.onAuthStateChange((event, session) => {
        if (session?.user) {
            currentUser = session.user;
            updateAuthUI(true);
            load();
        } else {
            currentUser = null;
            updateAuthUI(false);
        }
    });

    // Verificar sesi√≥n existente
    const { data: { session } } = await _supabase.auth.getSession();
    if (session?.user) {
        currentUser = session.user;
        updateAuthUI(true);
        load();
    } else {
        updateAuthUI(false);
        // Cargar datos locales aunque no est√© logueado
        const s = localStorage.getItem('tabOrganizer');
        if (s) { try { SECTIONS = JSON.parse(s); render(); } catch(e) {} }
    }
}

function updateAuthUI(isLoggedIn) {
    const authBtn = document.getElementById('auth-btn');
    const userEmail = document.getElementById('user-email');
    const welcomeScreen = document.getElementById('welcome-screen');

    if (isLoggedIn && (currentUser || isGuest)) {
        authBtn.textContent = 'Logout';
        authBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
        authBtn.classList.add('bg-red-600', 'hover:bg-red-500');

        if (isGuest) {
            userEmail.textContent = 'üë§ Invitado';
        } else {
            userEmail.textContent = currentUser.email;
        }
        userEmail.classList.remove('hidden');
        welcomeScreen.classList.remove('modal-active');
        welcomeScreen.classList.add('hidden');
    } else {
        authBtn.textContent = 'Login';
        authBtn.classList.remove('bg-red-600', 'hover:bg-red-500');
        authBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
        userEmail.classList.add('hidden');
        welcomeScreen.classList.add('modal-active');
        welcomeScreen.classList.remove('hidden');
    }
}

async function loginWithGoogle() {
    const { error } = await _supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
            redirectTo: window.location.origin + window.location.pathname
        }
    });
    if (error) {
        console.error('Error de login:', error);
        alert('Error al iniciar sesi√≥n: ' + error.message);
    }
}

// Email/Password Authentication
function showAuthError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000);
}

async function signUpWithEmail() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;

    if (!email || !password) {
        showAuthError('Por favor ingresa email y contrase√±a');
        return;
    }
    if (password.length < 6) {
        showAuthError('La contrase√±a debe tener al menos 6 caracteres');
        return;
    }

    const { data, error } = await _supabase.auth.signUp({
        email,
        password
    });

    if (error) {
        console.error('Error signUp:', error);
        showAuthError(error.message);
    } else if (data.user && !data.session) {
        showAuthError('Revisa tu email para confirmar tu cuenta');
    }
}

async function signInWithEmail() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;

    if (!email || !password) {
        showAuthError('Por favor ingresa email y contrase√±a');
        return;
    }

    const { data, error } = await _supabase.auth.signInWithPassword({
        email,
        password
    });

    if (error) {
        console.error('Error signIn:', error);
        showAuthError(error.message);
    }
}

// Guest Mode - Solo localStorage
function enterGuestMode() {
    isGuest = true;
    currentUser = null;
    updateAuthUI(true);

    // Cargar datos locales
    const s = localStorage.getItem('tabOrganizer');
    if (s) { try { SECTIONS = JSON.parse(s); } catch(e) {} }

    render();
    document.getElementById('cloud-status').innerText = "üë§ Modo Invitado";
    document.getElementById('cloud-status').style.color = "#fbbf24";
}

async function logout() {
    if (!isGuest) {
        const { error } = await _supabase.auth.signOut();
        if (error) {
            console.error('Error de logout:', error);
        }
    }
    isGuest = false;
    currentUser = null;
    SECTIONS = {};
    render();
    updateAuthUI(false);
}

async function handleAuth() {
    if (currentUser || isGuest) {
        logout();
    } else {
        // Mostrar welcome screen
        document.getElementById('welcome-screen').classList.add('modal-active');
        document.getElementById('welcome-screen').classList.remove('hidden');
    }
}

// ================= AUTO-METADATA =================
let fetchTimeout;
async function fetchMetadata(url) {
    if (!url.startsWith('http')) return;
    
    clearTimeout(fetchTimeout);
    fetchTimeout = setTimeout(async () => {
        const status = document.getElementById('auto-status');
        status.innerText = "‚è≥ Extrayendo info...";
        status.classList.add('loading-pulse');

        try {
            const response = await fetch(`https://api.microlink.io?url=${encodeURIComponent(url)}`);
            const { data } = await response.json();

            if (data) {
                document.getElementById('link-title').value = data.title || "";
                document.getElementById('link-desc').value = data.description || "";
                const iconUrl = data.logo?.url || data.image?.url || `https://www.google.com/s2/favicons?sz=128&domain=${new URL(url).hostname}`;
                document.getElementById('link-icon-preview').src = iconUrl;
                status.innerText = "‚ú® Auto-completado";
            }
        } catch (e) {
            status.innerText = "‚ö†Ô∏è Error al cargar info";
        } finally {
            status.classList.remove('loading-pulse');
        }
    }, 800);
}

// ================= PERSISTENCIA =================
async function save(){
    // Siempre guardar en localStorage como backup
    localStorage.setItem('tabOrganizer', JSON.stringify(SECTIONS));

    const status = document.getElementById('cloud-status');

    // Solo localStorage para modo invitado
    if (isGuest) {
        status.innerText = "üë§ Modo Invitado";
        status.style.color = "#fbbf24";
        return;
    }

    // Solo sincronizar con la nube si hay usuario autenticado
    if (!currentUser) {
        status.innerText = "üíæ Local";
        status.style.color = "#fbbf24";
        return;
    }

    status.innerText = "‚òÅÔ∏è Guardando...";
    status.style.color = "#60a5fa";

    const { error } = await _supabase.from('tab_organizer').upsert([{
        user_id: currentUser.id,
        url: 'backup',
        title: 'FullData',
        category: JSON.stringify(SECTIONS)
    }], { onConflict: 'user_id' });

    status.innerText = error ? "‚ùå Error Nube" : "‚úÖ Sincronizado";
    status.style.color = error ? "#ef4444" : "#4ade80";
}

async function load(){
    // Cargar desde localStorage primero
    const s = localStorage.getItem('tabOrganizer');
    if (s) { try { SECTIONS = JSON.parse(s); render(); } catch(e) {} }

    // Solo localStorage para modo invitado
    if (isGuest) {
        document.getElementById('cloud-status').innerText = "üë§ Modo Invitado";
        document.getElementById('cloud-status').style.color = "#fbbf24";
        return;
    }

    // Solo cargar de la nube si hay usuario autenticado
    if (!currentUser) {
        document.getElementById('cloud-status').innerText = "üíæ Modo Local";
        return;
    }

    const { data, error } = await _supabase
        .from('tab_organizer')
        .select('category')
        .eq('user_id', currentUser.id)
        .maybeSingle();

    if (data?.category) {
        SECTIONS = JSON.parse(data.category);
        localStorage.setItem('tabOrganizer', JSON.stringify(SECTIONS)); // Actualizar backup local
        render();
        document.getElementById('cloud-status').innerText = "‚úÖ Datos Nube";
    } else if (!error) {
        document.getElementById('cloud-status').innerText = "üÜï Usuario Nuevo";
    }
}

// ================= UI RENDER =================
function render(){
    const container = document.getElementById('sections-container');
    container.innerHTML = '';

    Object.keys(SECTIONS).forEach(k => {
        if (focusCategory && focusCategory !== k) return;
        const s = SECTIONS[k];
        const isOpen = openSections.has(k);
        const div = document.createElement('div');
        div.className = `glass rounded-3xl overflow-hidden border-l-[6px] shadow-lg mb-6 transition-all`;
        div.style.borderColor = s.color;

        div.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-6 cursor-pointer hover:bg-white/[0.02] transition" onclick="toggleSectionDisplay('${k}')">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl">${s.icon}</span>
                        <h2 class="text-xl font-bold text-white uppercase tracking-tight">${s.name}</h2>
                        ${s.progress ? `<span class="text-[10px] bg-blue-500/20 px-2 py-0.5 rounded text-blue-400 font-bold border border-blue-500/30 uppercase">${s.progress}</span>` : ''}
                    </div>
                    ${s.description ? `<p class="text-xs text-slate-500 ml-12 mt-1 line-clamp-1">${s.description}</p>` : ''}
                </div>
                <div class="flex items-center gap-3 mt-4 md:mt-0" onclick="event.stopPropagation()">
                    <button class="px-4 py-2 rounded-xl text-xs font-bold text-blue-400 bg-blue-400/10 hover:bg-blue-400/20 transition" onclick="addLink('${k}')">+ LINK</button>
                    <button class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-700 transition" onclick="toggleFocus('${k}')">${focusCategory===k?'EXIT':'FOCUS'}</button>
                    ${manageCategories ? `
                        <button class="px-3 py-2 rounded-xl text-xs font-bold bg-white/10 hover:bg-white/20 transition" onclick="openCategoryModal('${k}')">EDIT</button>
                        <button class="px-3 py-2 rounded-xl text-xs font-bold bg-red-500/20 text-red-500 hover:bg-red-500/30 transition" onclick="deleteCategory('${k}')">DEL</button>
                    ` : ''}
                </div>
            </div>

            <div class="${isOpen ? '' : 'hidden'} p-6 pt-0 bg-black/10 border-t border-white/5 transition-all">
                <div class="mb-6 p-5 rounded-2xl bg-white/[0.03] border border-white/5 flex items-center gap-4 mt-6 group" onclick="event.stopPropagation()">
                    <div class="w-1.5 h-10 rounded-full" style="background:${s.color}"></div>
                    <div class="flex-1">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Buscador inteligente</p>
                        <input class="w-full bg-transparent text-sm font-medium text-white outline-none focus:text-blue-400 transition"
                               value="${s.task || ''}" placeholder="Filtra links por palabra clave..."
                               onkeydown="if(event.key==='Enter') { saveTask('${k}', this.value); this.blur(); }"
                               onblur="saveTask('${k}', this.value)">
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    ${renderLinks(k)}
                </div>
            </div>
        `;
        container.appendChild(div);
    });
    document.getElementById('manageBtn').innerText = manageCategories ? 'Hecho' : 'Gestionar';
}

function renderLinks(k){
    const links = SECTIONS[k].links || [];
    const taskText = (SECTIONS[k].task || '').toLowerCase().trim();
    const taskWords = taskText.split(/\s+/).filter(w => w.length > 2);

    if (!links.length) return `<div class="col-span-full py-6 text-center text-slate-600 italic">Lista vac√≠a.</div>`;

    return links.map((l, i) => {
        const titleMatch = taskWords.some(word => l.title.toLowerCase().includes(word));
        const descMatch = taskWords.some(word => (l.description || '').toLowerCase().includes(word));
        const isSmart = taskWords.length > 0 && (titleMatch || descMatch);
        const isWatching = l.isWatching || false;
        const embed = getEmbedInfo(l.url);
        const pid = `${k}-${i}`;

        let cardClass = "glass-card p-4 rounded-2xl border flex flex-col gap-4 group ";
        if (isWatching) cardClass += "watching-now";
        else if (isSmart) cardClass += "smart-highlight";

        return `
        <div class="${cardClass}" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center gap-3">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <img src="${l.icon || 'https://www.google.com/s2/favicons?sz=64&domain=' + l.url}" class="w-10 h-10 rounded-lg bg-slate-800 object-contain p-1 border border-white/5 shadow-inner">
                    <div class="truncate">
                        <a href="${l.url}" target="_blank" class="text-sm font-bold ${isWatching ? 'text-green-400' : 'text-blue-400'} hover:underline block truncate">
                            ${isWatching ? 'üü¢ ' : ''}${l.title}
                        </a>
                        <p class="text-[10px] text-slate-500 truncate mt-0.5">${l.description || 'Sin detalles'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 opacity-0 group-hover:opacity-100 transition-all">
                    <label class="switch" title="Actualmente viendo">
                        <input type="checkbox" ${isWatching ? 'checked' : ''} onchange="toggleWatching('${k}', ${i})">
                        <span class="slider"></span>
                    </label>
                    <button class="text-blue-400/60 hover:text-blue-400 transition" onclick="editLink('${k}', ${i})" title="Editar">‚úèÔ∏è</button>
                    <button class="text-red-500/40 hover:text-red-500 transition" onclick="deleteLink('${k}', ${i})" title="Eliminar">üóëÔ∏è</button>
                </div>
            </div>
            ${embed ? `<button class="w-full py-1 rounded-lg bg-white/5 text-[9px] font-bold text-slate-500 uppercase hover:bg-white/10 transition" onclick="togglePreview('${pid}', '${embed.type}', '${embed.src}')">Ver Preview</button><div id="preview-${pid}"></div>` : ''}
        </div>`;
    }).join('');
}

// ================= LOGICA =================
function toggleSectionDisplay(k) { if (openSections.has(k)) openSections.delete(k); else openSections.add(k); render(); }
function saveTask(k, val) { SECTIONS[k].task = val; save(); render(); }
function toggleWatching(k, i) {
    SECTIONS[k].links.forEach((link, idx) => { if(idx !== i) link.isWatching = false; });
    SECTIONS[k].links[i].isWatching = !SECTIONS[k].links[i].isWatching;
    save(); render();
}
function toggleFocus(k){ focusCategory = (focusCategory === k) ? null : k; render(); }
function toggleManageCategories(){ manageCategories = !manageCategories; render(); }
function deleteCategory(k) { if(confirm(`¬øBorrar categor√≠a completa?`)) { delete SECTIONS[k]; save(); render(); } }

function openCategoryModal(key=null){
    editingCategoryKey = key;
    document.getElementById('cat-name').value = key ? SECTIONS[key].name : '';
    document.getElementById('cat-progress').value = key ? SECTIONS[key].progress : '';
    document.getElementById('cat-desc').value = key ? SECTIONS[key].description : '';
    renderPickers(key ? SECTIONS[key].icon : 'üìÅ', key ? SECTIONS[key].color : '#4a9eff');
    document.getElementById('category-modal').classList.add('modal-active');
}

function renderPickers(selI, selC){
    const ig = document.getElementById('icon-grid'); ig.innerHTML = '';
    ICONS.forEach(i => {
        const d = document.createElement('div');
        d.className = `cursor-pointer p-2 rounded-xl text-xl bg-white/5 hover:bg-white/10 ${i===selI ? 'ring-2 ring-blue-500' : ''}`;
        d.textContent = i; d.onclick = () => renderPickers(i, selC);
        ig.appendChild(d); if(i===selI) d.id = "selected-icon";
    });
    const cg = document.getElementById('color-grid'); cg.innerHTML = '';
    COLORS.forEach(c => {
        const d = document.createElement('div');
        d.className = `w-8 h-8 rounded-full cursor-pointer border-2 transition hover:scale-110 ${c===selC ? 'border-white' : 'border-transparent'}`;
        d.style.background = c; d.onclick = () => renderPickers(selI, c);
        cg.appendChild(d); if(c===selC) d.id = "selected-color";
    });
}

function saveCategory(){
    const name = document.getElementById('cat-name').value.trim();
    if (!name) return;
    const data = {
        name,
        icon: document.getElementById('selected-icon').textContent,
        color: document.getElementById('selected-color').style.backgroundColor,
        progress: document.getElementById('cat-progress').value,
        description: document.getElementById('cat-desc').value,
        links: editingCategoryKey ? SECTIONS[editingCategoryKey].links : [],
        task: editingCategoryKey ? SECTIONS[editingCategoryKey].task : ''
    };
    if (editingCategoryKey) SECTIONS[editingCategoryKey] = data;
    else SECTIONS[Date.now()] = data;
    save(); closeCategoryModal(); render();
}

function closeCategoryModal(){ document.getElementById('category-modal').classList.remove('modal-active'); }

function addLink(k){
    activeCategory = k;
    editingLinkIndex = null; // Modo agregar
    document.getElementById('link-modal-title').textContent = 'Nuevo Link';
    document.getElementById('link-url').value = "";
    document.getElementById('link-title').value = '';
    document.getElementById('link-desc').value = '';
    document.getElementById('link-icon-preview').src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
    document.getElementById('auto-status').innerText = "";
    document.getElementById('link-modal').classList.add('modal-active');
}

function editLink(k, i){
    activeCategory = k;
    editingLinkIndex = i; // Modo editar
    const link = SECTIONS[k].links[i];
    document.getElementById('link-modal-title').textContent = 'Editar Link';
    document.getElementById('link-url').value = link.url || '';
    document.getElementById('link-title').value = link.title || '';
    document.getElementById('link-desc').value = link.description || '';
    document.getElementById('link-icon-preview').src = link.icon || "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
    document.getElementById('auto-status').innerText = "";
    document.getElementById('link-modal').classList.add('modal-active');
}

function saveLink(){
    const l = {
        url: document.getElementById('link-url').value,
        title: document.getElementById('link-title').value || 'Sin T√≠tulo',
        description: document.getElementById('link-desc').value,
        icon: document.getElementById('link-icon-preview').src,
        isWatching: editingLinkIndex !== null ? SECTIONS[activeCategory].links[editingLinkIndex].isWatching : false
    };
    if(!l.url) return;

    if (editingLinkIndex !== null) {
        // Modo editar: actualizar link existente
        SECTIONS[activeCategory].links[editingLinkIndex] = l;
    } else {
        // Modo agregar: nuevo link
        SECTIONS[activeCategory].links.push(l);
    }

    save(); closeLinkModal(); render();
}

function closeLinkModal(){ document.getElementById('link-modal').classList.remove('modal-active'); }
function deleteLink(k, i){ if(confirm('¬øBorrar link?')) { SECTIONS[k].links.splice(i, 1); save(); render(); } }

function getYouTubeVideoId(url){
    try{
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.replace('/','');
        if (u.hostname.includes('youtube.com')) return u.searchParams.get('v');
    } catch(e){} return null;
}

function getEmbedInfo(url){
    const ytId = getYouTubeVideoId(url);
    if (ytId) return { type:'youtube', src:`https://www.youtube-nocookie.com/embed/${ytId}` };
    if (url.match(/\.(mp4|webm)$/i)) return { type:'file', src:url };
    return null;
}

function togglePreview(id, type, src){
    const el = document.getElementById(`preview-${id}`);
    if (el.innerHTML) { el.innerHTML = ''; return; }
    el.innerHTML = `<div class="aspect-video bg-black rounded-xl overflow-hidden mt-3 border border-white/10">${type === 'file' ? `<video controls class="w-full h-full" src="${src}"></video>` : `<iframe class="w-full h-full" src="${src}" allowfullscreen></iframe>`}</div>`;
}

// INICIO
initAuth();
render();
</script>
</body>
</html> 

